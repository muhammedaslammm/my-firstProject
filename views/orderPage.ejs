<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <script
      src="https://kit.fontawesome.com/f620fbbfb3.js"
      crossorigin="anonymous"
    ></script>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500&family=Poppins:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&family=Quicksand&family=Roboto:wght@400;500;700&display=swap"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css"
    />
    <link rel="stylesheet" href="/styles/nav.css" />
    <title>Order Page</title>
    <style>
      body {
        font-family: "poppins", sans-serif;
        padding-bottom: 100px;
        background-color: rgb(248, 248, 248);
      }
      .link-section {
        background-color: rgb(248, 248, 248);
        width: 85%;
        position: fixed;
        top: 56px;
        left: 8.5%;
        height: 105px;
        display: flex;
        align-items: end;
        margin: 0px auto 10px;
      }
      .link-section a {
        font-size: 15px;
        color: rgb(178, 178, 178);
        margin-right: 10px;
        margin-bottom: 57px;
        text-decoration: none;
      }
      .link-section span {
        font-size: 15px;
        text-decoration: none;
        color: grey;
        font-weight: 500;
        margin-left: 2px;
        margin-bottom: 57px;
      }
      .page-body {
        width: 85%;
        margin: 110px auto 20px;
        display: flex;
      }
      .sidebar {
        background-color: white;
        position: fixed;
        padding: 10px;
        width: 15%;
        box-shadow: 0px 0px 5px rgb(165, 164, 164);
      }
      .sidebar-head {
        font-size: 17px;
        font-weight: 500;
      }

      /* order section */
      .order-section {
        width: 65%;
        margin-left: 22%;
      }
      .search-box {
        width: 100%;
        background-color: rgb(248, 248, 248);
        position: fixed;
        z-index: 1;
      }
      .search-box input[type="search"] {
        border: none;
        width: 45.5%;
        box-shadow: 0px 0px 5px rgb(165, 164, 164);
        background-color: white;
        padding: 12px 18px;
        outline: none;
        font-size: 16px;
      }
      .search-box input[type="submit"] {
        border: none;
        box-shadow: 0px 0px 5px rgb(165, 164, 164);
        background-color: rgba(39, 177, 83, 0.701);
        padding: 12px 8px;
      }
      input[type="submit"]:hover {
        box-shadow: 0px 0px 5px rgb(165, 164, 164);
      }
      /* ordered date */
      .ordered-date {
        font-size: 15px;
        font-weight: 500;
        color: rgb(158, 158, 158);
        margin-top: 30px;
        margin-bottom: 7px;
      }
      .order-date:first-child {
        margin-top: 50px;
      }

      /* product card */
      .product-card {
        background-color: white;
        display: flex;
        justify-content: space-between;
        margin-bottom: 10px;
        box-shadow: 0px 0px 5px rgb(185, 184, 184);
        padding: 15px 20px;
        text-decoration: none;
        color: black;
        transition: box-shadow 0.3s;
      }

      #product-card:hover {
        cursor: pointer;
      }
      .product-card:hover {
        text-decoration: none;
        color: black;
        box-shadow: 0px 0px 9px rgb(161, 160, 160);
      }
      /* static card */
      .product-left-multi .head {
        font-size: 17px;
      }
      .discount-price {
        font-weight: 500;
        font-size: 18px;
      }
      .product-card .payment-method {
        font-size: 13px;
        color: rgb(125, 125, 125);
        margin-top: 9px;
      }
      .product-card .payment-method span {
        color: rgb(125, 125, 125);
        font-weight: 500;
      }
      .product-left-multi .date,
      .product-card .product-details .date {
        font-size: 13px;
        color: rgb(127, 127, 127);
      }

      .product-right-multi {
        display: flex;
      }
      .status-section {
        margin-right: 20px;
      }
      .status-section button {
        background-color: white;
        padding: 5px;
        border: 1px solid rgb(216, 25, 25);
        color: rgb(216, 25, 25);
      }
      .payment-section .note {
        font-size: 15px;
        font-weight: 500;
        color: rgb(183, 75, 75);
      }
      .payment-button {
        margin-top: 5px;
        font-size: 14px;
        border: 1px solid rgb(50, 145, 50);
        color: rgb(50, 145, 50);
        border-radius: 3px;
        padding: 1px 5px;
      }
      .payment-button:hover {
        cursor: pointer;
      }
      .status-section button:hover {
        cursor: pointer;
      }
      #view-more-button {
        background-color: white;
        border: 1px solid black;
        padding: 5px;
      }
      #view-more-button:hover {
        cursor: pointer;
      }

      /* product-left */
      .product-left {
        display: flex;
        width: 50%;
      }
      .product-card .image {
        width: 11%;
        height: auto;
        margin-right: 2.5%;
      }
      .product-card .image img {
        width: 100%;
      }
      /* details */
      .product-details {
        line-height: 20px;
        margin-left: 8px;
      }
      .brand {
        font-weight: 500;
        font-size: 17px;
        margin-bottom: 1px;
      }
      .color {
        margin-top: 2px;
        color: rgb(93, 92, 92);
        font-size: 15px;
      }

      /* middle */
      .product-middle {
        line-height: 20px;
        display: flex;
        width: 40%;
        justify-content: space-between;
        position: relative;
      }
      .productOrderID {
        width: 48%;
        box-sizing: border-box;
      }
      .orderID-head {
        font-size: 13.5px;
        color: rgb(90, 90, 90);
      }
      .orderID {
        font-size: 15px;
        font-weight: 500;
        color: rgb(73, 73, 73);
      }
      .price {
        width: 47%;
      }

      /* product-right */
      .product-right {
        line-height: 20px;
      }
      .delDate-head {
        font-size: 500;
        color: rgb(7, 122, 7);
      }
      .delDate {
        font-weight: 500;
        color: rgb(7, 122, 7);
      }

      /* hidden products */
      #hidden-product-cards {
        display: block;
      }
    </style>
  </head>
  <body>
    <!-- headers -->
    <%-include("./partials/navbar.ejs")%>
    <!-- -- -->
    <div class="link-section">
      <a href="/user-profile">>Profile page</a> <span>>order page</span>
    </div>
    <div class="page-body">
      <div class="sidebar">
        <div class="sidebar-head">Filters</div>
        <div class="order-status"></div>
      </div>
      <div class="order-section">
        <div class="search-box">
          <input type="search" placeholder="Search your order here..." />
          <input type="submit" />
        </div>
        <%if(orders.length > 0){%>
        <!-- splitting orders -->
        <%orders.forEach(function(order){%>
        <div class="ordered-date"><%=order.orderedDate.toDateString()%></div>
        <%if(order.orderedProducts.length > 1){%>
        <div class="product-card">
          <div class="product-left-multi">
            <div class="head">
              Multiple products Placed For
              <span class="discount-price">Rs. <%=order.orderTotal%></span>
            </div>
            <div class="payment-method">
              Payment method : <span><%=order.paymentMethod%></span>
            </div>
            <div class="date"><%=order.orderedDate.toDateString()%></div>
          </div>
          <div class="order-middle-multi">
            <%const paymentFailed = order.orderedProducts.every((product) =>
            product.orderStatus === 'pending')%> <%if(paymentFailed){%>
            <div class="payment-section">
              <div class="note">Your Payment is Pending</div>
              <div
                class="payment-button"
                onclick="continuePayment('<%=order.orderTotal%>','<%=order._id%>')"
              >
                Click here to continue payment
              </div>
            </div>
            <%}%>
          </div>
          <div class="product-right-multi">
            <div class="button">
              <button
                id="view-more-button"
                onclick="viewMore(event,'<%=order._id%>')"
              >
                view products
              </button>
            </div>
          </div>
        </div>
        <!-- splitting products -->
        <div
          id="hidden-product-cards"
          data-orderID="<%=order._id%>"
          style="display: none"
        >
          <%order.orderedProducts.forEach(function(product){%>
          <div
            class="product-card"
            onclick="viewOrder('<%=order._id%>','<%=product._id%>')"
            id="product-card"
          >
            <div class="product-left">
              <div class="image">
                <img
                  src="<%=product.productID.images[0]%>"
                  alt="product image"
                />
              </div>
              <div class="product-details">
                <div class="brand"><%=product.productID.brand%></div>
                <div class="details">
                  <%=product.productID.color%> Men's
                  <%=product.productID.productType%>
                </div>
                <div class="color">Color: <%=product.productID.color%></div>
              </div>
            </div>
            <div class="product-middle">
              <div class="productOrderID">
                <div class="orderID-head">Order ID</div>
                <div class="orderID"><%=product.moasOrderID%></div>
              </div>
              <div class="price">Rs. <%=product.totalPrice%></div>
            </div>
            <div class="product-right">
              <!-- on progress -->
              <%if(product.orderStatus === 'on progress'){%>
              <div class="date-note" style="color: rgb(184, 166, 34)">
                Delivery Expected on
              </div>
              <div
                class="date"
                style="color: rgb(184, 166, 34); font-weight: 500"
              >
                <%=product.deliveryDate.toDateString()%>
              </div>

              <!-- cancelled -->
              <%}else if(product.orderStatus === 'cancelled'){%>
              <div class="date-note" style="color: rgb(159, 20, 20)">
                Order Cancelled on
              </div>
              <div
                class="date"
                style="color: rgb(159, 20, 20); font-weight: 500"
              >
                <%=product.cancelledDate.toDateString()%>
              </div>

              <!-- delivered -->
              <%}else if(product.orderStatus === "delivered"){%>
              <div class="date-note" style="color: rgb(39, 93, 39)">
                Order Delivered on
              </div>
              <div
                class="date"
                style="color: rgb(39, 93, 39); font-weight: 500"
              >
                <%=product.deliveredDate.toDateString()%>
              </div>

              <!-- requesting for the product return -->
              <%}else if(product.orderStatus === 'requested'){%>
              <div
                class="request-note"
                style="color: rgb(154, 27, 27); font-weight: 500"
              >
                Requested for return
              </div>

              <!-- request accepted by the admin -->
              <%}else if(product.orderStatus === 'request accepted'){%>
              <div
                class="request-accepted"
                style="color: rgb(202, 145, 41); font-weight: 500"
              >
                Returning Product
              </div>

              <!-- product returned -->
              <%}else if(product.orderStatus === 'returned'){%>
              <div class="returned" style="color: rgb(138, 52, 21)">
                Product Returned on
              </div>
              <div
                class="returned-date"
                style="color: rgb(138, 52, 21); font-weight: 500"
              >
                <%=product.returnedDate.toDateString()%>
              </div>
              <%}else if(product.orderStatus === 'pending'){%>
              <div class="pendings" style="color: orangered">
                Payment Pending
              </div>
              <%}%>
            </div>
          </div>
          <%})%>
        </div>

        <%}else{%>
        <div
          class="product-card"
          id="product-card"
          onclick="viewOrder('<%=order._id%>','<%=order.orderedProducts[0]._id%>')"
        >
          <div class="product-left">
            <%const product = order.orderedProducts[0].productID%>
            <div class="image">
              <img
                src="<%=order.orderedProducts[0].productID.images[0]%>"
                alt="product image"
              />
            </div>
            <div class="product-details">
              <div class="brand"><%=product.brand%></div>
              <div class="details">
                <%=product.color%> Men's <%=product.productType%>
              </div>
              <div class="color">Color: <%=product.color%></div>
              <div class="payment-method">
                Payment method : <span><%=order.paymentMethod%></span>
              </div>
              <div class="date"><%=order.orderedDate.toDateString()%></div>
            </div>
          </div>
          <div class="product-middle">
            <div class="productOrderID">
              <div class="orderID-head">Order ID</div>
              <div class="orderID">
                <%=order.orderedProducts[0].moasOrderID%>
              </div>
            </div>
            <div class="price">
              Rs. <%=order.orderedProducts[0].couponAdded &&
              order.orderedProducts.length === 1 ? order.orderTotal :
              order.orderedProducts[0].totalPrice%>
            </div>
          </div>
          <div class="product-right">
            <%const productOrder = order.orderedProducts[0]%>

            <!-- on progress -->
            <%if(productOrder.orderStatus === 'on progress'){%>
            <div class="date-note" style="color: rgb(184, 166, 34)">
              Delivery Expected on
            </div>
            <div
              class="date"
              style="color: rgb(184, 166, 34); font-weight: 500"
            >
              <%=productOrder.deliveryDate.toDateString()%>
            </div>

            <!-- cancelled -->
            <%}else if(productOrder.orderStatus === 'cancelled'){%>
            <div class="date-note" style="color: rgb(159, 20, 20)">
              Order Cancelled on
            </div>
            <div class="date" style="color: rgb(159, 20, 20); font-weight: 500">
              <%=productOrder.cancelledDate.toDateString()%>
            </div>

            <!-- delivered -->
            <%}else if(productOrder.orderStatus === 'delivered'){%>
            <div class="date-note" style="color: rgb(39, 93, 39)">
              Order Delivered on
            </div>
            <div class="date" style="color: rgb(39, 93, 39); font-weight: 500">
              <%=productOrder.deliveredDate.toDateString()%>
            </div>

            <!-- requested for return -->
            <%}else if(productOrder.orderStatus === 'requested'){%>
            <div
              class="request-note"
              style="color: rgb(154, 27, 27); font-weight: 500"
            >
              Requested for return
            </div>

            <!-- request accepted -->
            <%}else if(productOrder.orderStatus === 'request accepted'){%>
            <div
              class="request-accepted"
              style="color: rgb(202, 145, 41); font-weight: 500"
            >
              Returning Product
            </div>

            <!-- returned -->
            <%}else if(productOrder.orderStatus === 'returned'){%>
            <div class="returned" style="color: rgb(138, 52, 21)">
              Product Returned on
            </div>
            <div
              class="returned-date"
              style="color: rgb(138, 52, 21); font-weight: 500"
            >
              <%=productOrder.returnedDate.toDateString()%>
            </div>
            <%}else if(productOrder.orderStatus === 'pending'){%>
            <div class="pendings" style="color: orangered; font-weight: 500">
              Payment Pending
            </div>
            <%}%>
          </div>
        </div>
        <%}%> <%})%> <%}%>
      </div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script>
      // nav
      const profileButton = document.querySelector("#profile-button");
      const content = document.querySelector(".dropdown-content");

      profileButton.addEventListener("click", function (event) {
        event.preventDefault();
        content.style.display =
          content.style.display === "none" ? "block" : "none";
      });

      // hide and unhide the products
      function viewMore(event, orderID) {
        const buttonElement = event.target;
        const productSection = document.querySelector(
          `[data-orderID='${orderID}']`
        );
        buttonElement.innerText =
          buttonElement.innerText === "view products"
            ? "close products"
            : "view products";
        productSection.style.display =
          productSection.style.display === "none" ? "block" : "none";
      }

      // view product
      function viewOrder(orderID, productDocID) {
        window.location.href = `/view/${orderID}/${productDocID}`;
      }

      // razorpay
      async function continuePayment(orderTotal, orderID) {
        try {
          const response = await fetch("/create/orderId", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({ amount: orderTotal * 100 }),
          });
          if (response.ok) {
            const data = await response.json();
            const { orderId, orderprice, signature } = data;
            const options = {
              key: "rzp_test_3y4jRsuaFdH2Kn",
              amount: orderprice,
              currency: "INR",
              name: "moasWeb",
              description: "Online Payment",
              order_id: orderId,
              handler: function (response) {
                let form = document.createElement("form");
                form.method = "POST";
                form.action = "/continue-payment";

                // hidden input for passing orderID
                const input = document.createElement("input");
                input.type = "hidden";
                input.name = "orderID";
                input.value = orderID;
                form.appendChild(input);

                // payment status
                const statusInput = document.createElement("input");
                statusInput.type = "hidden";
                statusInput.name = "status";
                statusInput.value = "success";
                form.appendChild(statusInput);

                document.body.appendChild(form);
                form.submit();
              },
            };
            const razorpay = new Razorpay(options);
            razorpay.on("payment.failed", function (response) {
              let form = document.createElement("form");
              form.method = "POST";
              form.action = "/continue-payment";

              // hidden input for passing orderID
              const input = document.createElement("input");
              input.type = "hidden";
              input.name = "orderID";
              input.value = orderID;
              form.appendChild(input);

              // payment status
              const statusInput = document.createElement("input");
              statusInput.type = "hidden";
              statusInput.name = "status";
              statusInput.value = "failed";
              form.appendChild(statusInput);

              document.body.appendChild(form);
              form.submit();
            });
            razorpay.open();
          }
        } catch (error) {
          console.log("error", error);
        }
      }
    </script>
    <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
  </body>
</html>
